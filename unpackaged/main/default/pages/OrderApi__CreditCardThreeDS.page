<apex:page id="CreditCardThreeDS" showHeader="false" showChat="false" sidebar="false" controller="OrderApi.CreditCardThreeDSController">
    <script src="{!URLFOR($Resource.Framework__SLDS_BaseV2,'js/scripts.min.js')}" type="text/javascript"></script>
    <script src="https://core.spreedly.com/iframe/iframe-v1.min.js" type="text/javascript"></script>
    <link rel="stylesheet" media="screen" href="{!URLFOR($Resource.Framework__SLDS_BaseV2,'css/fullStyles.css')}"/>

    <style>
        .spreedly-iframe_custom {
            width: 100vw;
            height: 100vh;
            border: none;
        }
        #challenge {
            width: 100vw;
            background-color: #eee;
            display: flex;
            justify-content: center;
        }
        @media (min-width: 768px){
            .spreedly-iframe_custom {
                width: 50vw;
            }
        }
    </style>
    <div class="slds slds-loading-layout " id="spinner">
        <div class="slds-grid slds-loading-layout ">
            <div class="slds-col slds-text-align--center slds-align-middle" >
                <img src="{!URLFOR($Resource.Framework__SLDS_BaseV2,'/img/spinners/slds_spinner_brand.gif')}" alt="saving" width="50" height="50" />&nbsp;
                <span class="slds-text-heading--medium">{!processingChangesLabel}</span>
            </div>
        </div>
    </div>
    <apex:form id="theForm">
    <div class="slds fonteva">
        <div class="slds-col slds-grid slds-m-bottom--medium">
            <body>
              <div id="device-fingerprint" class="hidden"> </div>
              <div id="challenge-modal" class="hidden">
                  <div id="challenge"></div>
              </div>
            </body>
        </div>
    </div>
    <apex:actionFunction name="complete" action="{!processTransaction}" reRender="out"/>
    <apex:actionFunction name="authenticate" action="{!authorizeAuthenticatedAndSave}" reRender="out"/>
    <apex:actionFunction name="stripeOffsession" action="{!stripeOffsession}" reRender="out"/>
        <apex:outputPanel id="out"></apex:outputPanel>>
    </apex:form>
    <script type="text/javascript">
        $(document).ready(function(){
            var lifecycle = new Spreedly.ThreeDS.Lifecycle({
            environmentKey: '{!JSENCODE($CurrentPage.parameters.environmentKey)}',
            hiddenIframeLocation: 'device-fingerprint',
            challengeIframeLocation: 'challenge',
            transactionToken: '{!JSENCODE($CurrentPage.parameters.token)}',
            challengeIframeClasses: 'spreedly-iframe_custom',
         })
            Spreedly.on('3ds:status', statusUpdates);
            var transactionData = {
                  state: '{!JSENCODE($CurrentPage.parameters.state)}',
                  required_action: '{!JSENCODE($CurrentPage.parameters.requiredAction)}',
                  device_fingerprint_form: '{!JSENCODE($CurrentPage.parameters.deviceFingerprintForm)}',
                  checkout_form: '{!JSENCODE($CurrentPage.parameters.checkoutForm)}',
                  checkout_url: '{!JSENCODE($CurrentPage.parameters.checkoutUrl)}',
                  challenge_form: '{!JSENCODE($CurrentPage.parameters.challengeForm)}',
                  challenge_url: '{!JSENCODE($CurrentPage.parameters.requiredAction)}',
            };
            lifecycle.start(transactionData)
        });

        var statusUpdates = function (event) {
          if (event.action === 'succeeded') {
            if ('{!JSENCODE($CurrentPage.parameters.authenticate)}') {
                  authenticate();
              } else if ('{!JSENCODE($CurrentPage.parameters.offsession)}'){
                  stripeOffsession();
              } else {
                  complete();
              }
          } else if (event.action === 'error') {
            if ('{!JSENCODE($CurrentPage.parameters.authenticate)}') {
                  authenticate();
              } else if ('{!JSENCODE($CurrentPage.parameters.offsession)}'){
                  stripeOffsession();
              } else {
                  complete();
              }
          } else if (event.action === 'challenge') {
              document.getElementById('challenge-modal').classList.remove('hidden');
          } else if (event.action === 'device-fingerprint') {
              document.getElementById('device-fingerprint').classList.remove('hidden');
          }else if (event.action === 'trigger-completion') {
              complete();
          }
        }

</script>
</apex:page>