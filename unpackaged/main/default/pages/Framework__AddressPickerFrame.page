<apex:page showHeader="false" showChat="false" sidebar="false" controller="Framework.AddressPickerFieldController">
    <script
        src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&key=AIzaSyCmg71UHGeaDKjszoNazRjlVtGcl9KMj2o"
    />
    <span class="slds">
        <div id="map" style="display: none;"></div>
    </span>
    <script type="text/javascript">
        var map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -33.8688, lng: 151.2195 },
            zoom: 13
        });
        var service = new google.maps.places.PlacesService(map);
        var componentForm = {
            street_number: { type: 'short_name', objectValue: 'street_number' },
            route: { type: 'long_name', objectValue: 'street_name' },
            premise: { type: 'short_name', objectValue: 'premise' },
            neighborhood: { type: 'long_name', objectValue: 'street_name' },
            locality: { type: 'long_name', objectValue: 'city' },
            postal_town: { type: 'long_name', objectValue: 'city' },
            administrative_area_level_1: { type: 'short_name', objectValue: 'province' },
            country: { type: '{!JSENCODE(countryLabelType)}', objectValue: 'country' },
            postal_code: { type: 'short_name', objectValue: 'postal_code' },
            postal_code_prefix: { type: 'short_name', objectValue: 'postal_code' }
        };

        function receiveMessage(event) {
            if (event.data.type === 'query') {
                var service = new google.maps.places.AutocompleteService();
                service.getPlacePredictions(
                    {
                        input: event.data.query,
                        types: ['geocode']
                    },
                    function (predictions, status) {
                        var predictionsObj = {
                            identifier: event.data.identifier,
                            predictions: predictions,
                            type: 'queryResult',
                            query: event.data.query
                        };
                        parent.window.postMessage(predictionsObj, '*');
                    }
                );
            } else if (event.data.type === 'placeDetail') {
                const service = new google.maps.places.PlacesService(map);
                service.getDetails(
                    {
                        placeId: event.data.placeId
                    },
                    function (place, status) {
                        const addressObject = {};
                        for (let i = 0; i < place.address_components.length; i++) {
                            const addressType = place.address_components[i].types[0];
                            if (componentForm[addressType]) {
                                // If the address value is already set for the address type, do not overwrite it.
                                if (addressObject[componentForm[addressType].objectValue]) {
                                    continue;
                                }
                                const val = place.address_components[i][componentForm[addressType].type];
                                addressObject[componentForm[addressType].objectValue] = val;
                            }
                        }
                        // some addresses do not have a value for administrative_area_level_1
                        // in which case we fall back on administrative_area_level_2
                        const administrativeAreaLevelResults = place.address_components.filter(function(addressComp){
                            return addressComp.types[0] === 'administrative_area_level_1';
                        }).concat(place.address_components.filter(function(addressComp){
                            return addressComp.types[0] === 'administrative_area_level_2';
                        }));
                        // assign value of administrative_area_level_1 OR administrative_area_level_2 as the value for administrative_area_level_1
                        if(administrativeAreaLevelResults.length) {
                            addressObject[componentForm['administrative_area_level_1'].objectValue] = administrativeAreaLevelResults[0][componentForm['administrative_area_level_1'].type]
                        }

                        // some addresses do not have a value for locality
                        // in which case we fall back on sublocality
                        const sublocalities = place.address_components.filter(function(addressComp){
                            return addressComp.types.includes('sublocality');
                        });
                        if (addressObject && sublocalities.length && !addressObject.hasOwnProperty(componentForm['locality'].objectValue)) {
                            addressObject[componentForm['locality'].objectValue] = sublocalities[0][componentForm['locality'].type];
                        }

                        const placeObj = { identifier: event.data.identifier, place: addressObject, type: 'placeDetail' };
                        parent.window.postMessage(placeObj, '*');
                    }
                );
            }
        }

        window.addEventListener('message', receiveMessage, false);
    </script>
</apex:page>